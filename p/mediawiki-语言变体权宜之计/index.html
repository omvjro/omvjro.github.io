<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在维基农场上为初始语言并非 zh 的站点添加语言变体/简繁转换功能"><title>MediaWiki 语言变体权宜之计</title>
<link rel=canonical href=https://omvjro.github.io/p/mediawiki-%E8%AF%AD%E8%A8%80%E5%8F%98%E4%BD%93%E6%9D%83%E5%AE%9C%E4%B9%8B%E8%AE%A1/><link rel=stylesheet href=/scss/style.min.000442301ad2403045ee451b78150ed31464a587d89ce3f4c887ff3b32d258b5.css><meta property="og:title" content="MediaWiki 语言变体权宜之计"><meta property="og:description" content="在维基农场上为初始语言并非 zh 的站点添加语言变体/简繁转换功能"><meta property="og:url" content="https://omvjro.github.io/p/mediawiki-%E8%AF%AD%E8%A8%80%E5%8F%98%E4%BD%93%E6%9D%83%E5%AE%9C%E4%B9%8B%E8%AE%A1/"><meta property="og:site_name" content="造车车间"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="JavaScript"><meta property="article:published_time" content="2023-11-28T00:00:00+00:00"><meta property="article:modified_time" content="2023-11-28T00:00:00+00:00"><meta name=twitter:title content="MediaWiki 语言变体权宜之计"><meta name=twitter:description content="在维基农场上为初始语言并非 zh 的站点添加语言变体/简繁转换功能"><link rel="shortcut icon" href=/assets/icons/brand-wikipedia.svg></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars.githubusercontent.com/u/144692181?v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>造车车间</a></h1><h2 class=site-description>开门造车车门开</h2></div></header><ol class=social-menu><li><a href=https://degreesoflewditycn.miraheze.org/wiki/Special:%e7%94%a8%e6%88%b7%e8%b4%a1%e7%8c%ae/+++%e5%ab%89%e5%a6%92 target=_blank title="DOL wiki" rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-wikipedia" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 4.984h2"/><path d="M8 4.984h2.5"/><path d="M14.5 4.984H17"/><path d="M22 4.984h-2"/><path d="M4 4.984 9.455 19.5 16 4.984"/><path d="M9 4.984 15 19.5l6-14.516"/></svg></a></li><li><a href=https://github.com/omvjro target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://paratranz.cn/users/44232 target=_blank title=ParaTranz rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-square-rounded-letter-p" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12h2a2 2 0 100-4h-2v8"/><path d="M12 3c7.2.0 9 1.8 9 9s-1.8 9-9 9-9-1.8-9-9 1.8-9 9-9z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#用户界面语言和站点内容语言>用户界面语言和站点内容语言</a></li><li><a href=#清除用户界面消息缓存>清除用户界面消息缓存</a></li><li><a href=#设置-wgforceuimsgascontentmsg>设置 <code>$wgForceUIMsgAsContentMsg</code></a></li><li><a href=#编写自定义变体脚本>编写自定义变体脚本</a><ol><li><a href=#opencc-js>opencc-js</a></li><li><a href=#外部脚本加载问题>外部脚本加载问题</a></li><li><a href=#只支持-es5-的屑-mediawiki>只支持 ES5 的屑 MediaWiki</a></li></ol></li><li><a href=#结果>结果</a></li><li><a href=#补遗>补遗</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/mediawiki/>MediaWiki</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/mediawiki-%E8%AF%AD%E8%A8%80%E5%8F%98%E4%BD%93%E6%9D%83%E5%AE%9C%E4%B9%8B%E8%AE%A1/>MediaWiki 语言变体权宜之计</a></h2><h3 class=article-subtitle>在维基农场上为初始语言并非 zh 的站点添加语言变体/简繁转换功能</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Nov 28, 2023</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><p>在 <a class=link href=https://degreesoflewditycn.miraheze.org/ target=_blank rel=noopener>DOL 中文 wiki</a> 中，或由于初始设置失误，语言设置为 <code>zh-CN</code> 而非 <code>zh</code>。根据 <a class=link href=https://www.mediawiki.org/wiki/Manual:$wgDisableLangConversion/zh target=_blank rel=noopener>MediaWiki 文档</a>，只有语言设置为 <code>zh</code> 才能启用自带的变体转换功能（以 <code>$wgDisableLangConversion</code> 设置）。</p><h2 id=用户界面语言和站点内容语言>用户界面语言和站点内容语言</h2><p>首先需由<a class=link href=https://www.mediawiki.org/wiki/Manual:Language target=_blank rel=noopener>文档</a>明确，MediaWiki 的语言分为三种：</p><ul><li>站点内容语言（Site content language）</li><li>用户界面语言（User interface language，API 调用为 <code>mw.user.options.values.language</code>）</li><li>页面内容语言（Page content language）</li></ul><p>其中页面内容语言极少需要配置，绝大部分情况下，都默认与 <code>站点内容语言</code> 一致，在此忽略。</p><p><code>站点内容语言</code> 决定了 <code>html</code> 的 <code>lang</code> 属性，在默认情况下，也决定了 wiki 具体内容的语言，实际使用上，主要有标题（<code>#firstHeading</code>）和内容（<code>#mw-content-text</code>）两部分。</p><p><code>用户界面语言</code> 决定了基础界面的 <code>lang</code> 属性，这些基础界面也就是“用户界面消息”（User interface message）。用户界面消息大部分由 MediaWiki 自动生成，例如命名空间的“User”（<code>en</code>）和“用户”（<code>zh</code>），能够随 <code>用户界面语言</code> 改变自己改变语言；但有一部分用户界面消息来自 MediaWiki 命名空间，最常用的如 <code>MediaWiki:Sidebar</code> 为侧边栏（<code>#site-navigation</code>），其 <code>lang</code> 属性虽能随 <code>用户界面语言</code> 改变而改变，具体内容却不会自动变化，需要额外设置用户界面消息。</p><h2 id=清除用户界面消息缓存>清除用户界面消息缓存</h2><p>作为往往在每个页面都有使用的内容，用户界面消息有着强大的缓存。根据 <a class=link href=https://www.mediawiki.org/wiki/Manual:$wgLanguageCode target=_blank rel=noopener>MediaWiki 文档</a>，更改 wiki 语言（<code>$wgLanguageCode</code>）后，需清除用户界面消息缓存，否则会无法显示新语言界面消息，或新旧语言界面消息混杂。其中提供了两种方法。</p><p>在 MediaWiki 1.18 及以上，运行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;MediaWiki\MediaWikiServices::getInstance()-&gt;getMessageCache()-&gt;clear()&#39;</span> <span class=p>|</span> php maintenance/eval.php
</span></span></code></pre></td></tr></table></div></div><p>在 MediaWiki 1.18 以下，则手动运行 <code>maintenance/rebuildmessages.php</code>。</p><p>然而，在 Miraheze 这样的维基农场中，往往无法如此清除缓存。</p><h2 id=设置-wgforceuimsgascontentmsg>设置 <code>$wgForceUIMsgAsContentMsg</code></h2><p>经指点并查<a class=link href=https://www.mediawiki.org/wiki/Manual:$wgForceUIMsgAsContentMsg target=_blank rel=noopener>文档</a>，亦可以设置 <code>$wgForceUIMsgAsContentMsg</code>，将用户界面消息设置为内容消息，即能够自己转换。</p><p>显然，在维基农场中，也不可改动这个设置。</p><h2 id=编写自定义变体脚本>编写自定义变体脚本</h2><p>试模拟原变体功能，在内容页面右上排按钮（<code>.mw-list-item</code>）中添加变体按钮，加入全站加载的 <code>MediaWiki:Common.js</code> 中。</p><h3 id=opencc-js>opencc-js</h3><p><a class=link href=https://github.com/BYVoid/OpenCC target=_blank rel=noopener>OpenCC</a> 是非常常用的一个简繁转换工具，凭借巨大的词库，可以实现各地不同繁体的转换，故欲以此编写转换脚本。原工具为 npm 包，难以直接使用，但有衍生 JavaScript 版本 <a class=link href=https://github.com/nk2028/opencc-js target=_blank rel=noopener>opencc-js</a>，此处则使用此版本。</p><p>摘抄用法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// Set Chinese convert from Traditional (Hong Kong) to Simplified (Mainland China)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>converter</span> <span class=o>=</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>Converter</span><span class=p>({</span> <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;hk&#39;</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;cn&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// Set the conversion starting point to the root node, i.e. convert the whole page
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>rootNode</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Convert all elements with attributes lang=&#39;zh-HK&#39;. Change attribute value to lang=&#39;zh-CN&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>HTMLConvertHandler</span> <span class=o>=</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>HTMLConverter</span><span class=p>(</span><span class=nx>converter</span><span class=p>,</span> <span class=nx>rootNode</span><span class=p>,</span> <span class=s1>&#39;zh-HK&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-CN&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>HTMLConvertHandler</span><span class=p>.</span><span class=nx>convert</span><span class=p>();</span> <span class=c1>// Convert  -&gt; 汉语
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>HTMLConvertHandler</span><span class=p>.</span><span class=nx>restore</span><span class=p>();</span> <span class=c1>// Restore  -&gt; 漢語
</span></span></span></code></pre></td></tr></table></div></div><p>由此按照 <code>lang</code> 属性转换的特性，可以为需转换内容设置不存在的 <code>lang</code> 属性，如 <code>zh-to-convert</code>，实现不影响其他部分的转换；对于易误转换的内容，如 <code>textarea</code>，也可以设置如 <code>zh-not-convert</code> 的 <code>lang</code> 属性，随后用 <code>restore</code> 方法转回原文。</p><p>特别是在 MediaWiki 中，需要转换的元素主要为标题（<code>#firstHeading</code>）、侧边栏（<code>#site-navigation</code>）、内容（<code>#mw-content-text</code>），这些部分的特点是具有 MediaWiki 根据 <code>站点内容语言</code> 或 <code>用户界面语言</code> 设定设置的 <code>lang</code> 属性；然而，<code>html</code> 同样拥有此属性，因此不能直接根据原属性转换。</p><p>opencc-js 亦支持自定义词典，在 wiki 实际使用中应很有用处，但暂不研究。</p><h3 id=外部脚本加载问题>外部脚本加载问题</h3><p>MediaWiki 中，传统的引入外部脚本的方式为使用 <code>mw.loader.load</code>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>mw</span><span class=p>.</span><span class=nx>loader</span><span class=p>.</span><span class=nx>load</span><span class=p>(</span> <span class=s1>&#39;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#39;</span> <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>然而，当网络情况不佳或脚本稍大（如 opencc-js）时，会出现未加载完成的情况。</p><p>幸而，在 MediaWiki 1.33 中，新增了一种引入外部脚本的方式，为 <code>mw.loader.getScript</code>，其会传回一个 Promise 对象。无需知道 Promise 对象的含义，只需参考示例代码，就能实现外部脚本加载完后执行函数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>mw</span><span class=p>.</span><span class=nx>loader</span><span class=p>.</span><span class=nx>getScript</span><span class=p>(</span> <span class=s1>&#39;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#39;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 之后执行的内容
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=只支持-es5-的屑-mediawiki>只支持 ES5 的屑 MediaWiki</h3><p>调试时可能出现报错，说明只能使用 ES5 语法。ES6 2015 年即推出，目前已经普遍支持，很容易不小心写出来。例如模板字符串、箭头函数等。</p><blockquote><p>然而，在一些 MediaWiki 网站中，是可以使用 ES6 语法的，关于这一点，尚未搜索到解决方法。</p></blockquote><h2 id=结果>结果</h2><p>以下为暂用的脚本，实现以 <code>localStorage</code> 存储用户偏好的变体转换，理论上可适用于所有 wiki，只需微调 CSS。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=c1>// 载入 openccjs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>mw</span><span class=p>.</span><span class=nx>loader</span><span class=p>.</span><span class=nx>getScript</span><span class=p>(</span> <span class=s1>&#39;https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js&#39;</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>(</span><span class=kd>function</span><span class=p>(){</span>
</span></span><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=kd>function</span><span class=p>(){</span> <span class=c1>// DOM 加载后操作
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// 设置转换工具，简体 -&gt; 港繁/台繁，台繁 -&gt; 简体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>cth</span> <span class=o>=</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>Converter</span><span class=p>({</span> <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;cn&#39;</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;hk&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>ttc</span> <span class=o>=</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>Converter</span><span class=p>({</span> <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;tw&#39;</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;cn&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>ctt</span> <span class=o>=</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>Converter</span><span class=p>({</span> <span class=nx>from</span><span class=o>:</span> <span class=s1>&#39;cn&#39;</span><span class=p>,</span> <span class=nx>to</span><span class=o>:</span> <span class=s1>&#39;tw&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置必要的 lang 属性以备后续转换
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#firstHeading&#39;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s1>&#39;lang&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#site-navigation ul&#39;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s1>&#39;lang&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#site-navigation h3&#39;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s1>&#39;lang&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#mw-content-text&#39;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s1>&#39;lang&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;textarea&#39;</span><span class=p>))</span> <span class=p>{</span> <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;textarea&#39;</span><span class=p>).</span><span class=nx>attr</span><span class=p>(</span><span class=s1>&#39;lang&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-not-convert&#39;</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 检查 localStorage 并转换
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>rootNode</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>HTMLConvertHandler</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cn&#34;</span><span class=o>:</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>HTMLConverter</span><span class=p>(</span><span class=nx>ttc</span><span class=p>,</span> <span class=nx>rootNode</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-CN&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;hk&#34;</span><span class=o>:</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>HTMLConverter</span><span class=p>(</span><span class=nx>cth</span><span class=p>,</span> <span class=nx>rootNode</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-HK&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;tw&#34;</span><span class=o>:</span> <span class=nx>OpenCC</span><span class=p>.</span><span class=nx>HTMLConverter</span><span class=p>(</span><span class=nx>ctt</span><span class=p>,</span> <span class=nx>rootNode</span><span class=p>,</span> <span class=s1>&#39;zh-to-convert&#39;</span><span class=p>,</span> <span class=s1>&#39;zh-TW&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;opencc&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>HTMLConvertHandler</span><span class=p>[</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;opencc&#39;</span><span class=p>)].</span><span class=nx>convert</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#opencc&#39;</span><span class=p>).</span><span class=nx>val</span><span class=p>(</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;opencc&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 插入样式和按钮
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;&lt;style&gt;.mw-list-item select {color: #68d;padding: inherit;padding-right: 2em;background-color: transparent;cursor: pointer;border: none;}.mw-list-item select:hover {border: none;}&lt;/style&gt;&#39;</span><span class=p>).</span><span class=nx>appendTo</span><span class=p>(</span><span class=s1>&#39;body&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;&lt;li class=&#34;mw-list-item&#34;&gt;&lt;select name=&#34;opencc&#34; id=&#34;opencc&#34;&gt;&lt;option value=&#34;&#34;&gt;不转换&lt;/option&gt;&lt;option value=&#34;cn&#34;&gt;大陆简体&lt;/option&gt;&lt;option value=&#34;hk&#34;&gt;港澳繁体&lt;/option&gt;&lt;option value=&#34;tw&#34;&gt;台湾繁体&lt;/option&gt;&lt;/select&gt;&lt;/li&gt;&#39;</span><span class=p>).</span><span class=nx>appendTo</span><span class=p>(</span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#p-views ul&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 用户修改变体后，设置 localStorage 并刷新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>$</span><span class=p>(</span><span class=s1>&#39;#opencc&#39;</span><span class=p>).</span><span class=nx>change</span><span class=p>(</span><span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>localStorage</span><span class=p>.</span><span class=nx>setItem</span><span class=p>(</span><span class=s1>&#39;opencc&#39;</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>location</span><span class=p>.</span><span class=nx>reload</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>效果如下：</p><p><img src=https://p.sda1.dev/14/54b68f6a606d0f24cf6e52e6f530e875/QQ%e6%88%aa%e5%9b%be20231112182613.png loading=lazy alt=效果></p><h2 id=补遗>补遗</h2><blockquote><p>The site content language (<code>ContentLanguage</code> service in <code>MediaWiki\MediaWikiServices::getContentLanguage</code>, based on <code>$wgLanguageCode</code>), which <strong>should generally stay the same as long as the wiki exists</strong>.</p></blockquote><p>最好的方法永远是保证最开始设置正确，权宜之计终归是权宜之计。利用这个脚本，可以实现对页面内容的正确变体转换，然而，在实际使用中，还有一些问题：</p><ul><li>需要额外创建繁体标题重定向</li><li>不支持转换后变体的搜索</li></ul><p>关于第一点，在<a class=link href=/p/mediawiki-%e8%af%ad%e8%a8%80%e5%8f%98%e4%bd%93%e8%a1%a5%e9%81%97/>这篇文章</a>中修修补补给出了解决方法。关于第二点，考虑到小 wiki 对搜索正文内容的需求不是很大，暂时只能如此了。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/javascript/>JavaScript</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/mediawiki-%E8%AF%AD%E8%A8%80%E5%8F%98%E4%BD%93%E8%A1%A5%E9%81%97/><div class=article-details><h2 class=article-title>Mediawiki 语言变体补遗</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 造车车间</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.21.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>